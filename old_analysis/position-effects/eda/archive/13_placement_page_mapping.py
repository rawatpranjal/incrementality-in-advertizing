#!/usr/bin/env python3
"""
Placement to Page Type Mapping (Revised with Product Diversity Analysis)

Maps placements P1, P2, P3, P5 to page types based on:
1. Behavioral patterns from data analysis (self-transition, co-firing)
2. Official Poshmark documentation (only 2 page types have ads)
3. Product diversity within auctions (NEW - from 15_placement_product_diversity.py)

Key Update: Product diversity analysis CONTRADICTS original P2/P5 mapping.
- P2 shows 99.2% single-brand auctions -> Brand/Seller page, NOT PDP
- P5 shows 45.53 brands/auction -> Category browse, NOT Brand page

Output: results/13_placement_page_mapping.txt
"""

import sys
from datetime import datetime

output_lines = []

def log(msg=""):
    print(msg)
    output_lines.append(msg)

log("=" * 80)
log("PLACEMENT TO PAGE TYPE MAPPING (REVISED WITH PRODUCT DIVERSITY)")
log("=" * 80)
log(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
log()

log("=" * 80)
log("OFFICIAL POSHMARK AD PLACEMENTS")
log("=" * 80)
log()
log("Source: poshmark.com/promoted-closet/learn")
log()
log("Poshmark's Promoted Closet documentation lists ONLY TWO placement surfaces:")
log()
log("  1. SEARCH RESULTS")
log("     'Your eligible listings can be surfaced in high-visibility spots")
log("     when shoppers search'")
log()
log("  2. BRAND PAGES")
log("     'Your listings can also appear on Brand pages (where shoppers")
log("     browse a specific brand)'")
log()
log("NOT official placements:")
log("  - Home feed: not listed as official placement")
log("  - Category pages: filtered browsing counts as 'Search results'")
log()

log("=" * 80)
log("EVIDENCE SOURCES")
log("=" * 80)
log()
log("This mapping synthesizes THREE independent analyses:")
log()
log("  1. BEHAVIORAL PATTERNS (10_placement_verification.txt)")
log("     - Self-transition rates, session starts, CTR")
log("     - Multi-slot clustering")
log()
log("  2. CO-FIRING ANALYSIS (14_cross_placement_cofiring.txt)")
log("     - Which placements fire within <1s of each other")
log("     - Indicates same-page vs different-page")
log()
log("  3. PRODUCT DIVERSITY (15_placement_product_diversity.txt) **NEW**")
log("     - Brand diversity within auctions")
log("     - Single-brand vs multi-brand auction rates")
log()

log("=" * 80)
log("KEY PRODUCT DIVERSITY FINDINGS")
log("=" * 80)
log()
log("From 15_placement_product_diversity.txt:")
log()
log("| Placement | Brands/Auction | Single-Brand% | Interpretation              |")
log("|-----------|----------------|---------------|------------------------------|")
log("| P1        | 11.37          | 52.9%         | Mixed (bimodal)              |")
log("| P2        | 1.01           | 99.2%         | EXTREME homogeneity          |")
log("| P3        | 18.14          | 8.2%          | Moderate diversity           |")
log("| P5        | 45.53          | 0.9%          | HIGHEST diversity            |")
log()
log("CRITICAL INSIGHT:")
log("  P2's 99.2% single-brand rate is INCONSISTENT with 'PDP recommendations'")
log("  which would show related products from multiple brands.")
log()
log("  P2's pattern matches SELLER CLOSET or BRAND PAGE viewing:")
log("  - User views seller's closet -> sees items from SAME seller (single brand)")
log("  - Top 'brand' in P2: 'meet the posher' (27.3%) = seller intro listings")
log()
log("  P5's pattern (45 brands/auction) is INCONSISTENT with 'Brand Page'")
log("  which would show products from ONE brand.")
log()
log("  P5's pattern matches CATEGORY BROWSE:")
log("  - User browses a category -> sees items from MANY brands")
log("  - 99% single department (category-specific)")
log()

log("=" * 80)
log("FINAL MAPPING (RECONCILED)")
log("=" * 80)
log()
log("| Placement | Page Type                  | Confidence | Key Evidence                |")
log("|-----------|----------------------------|------------|------------------------------|")
log("| P3        | Search Results             | High       | 88% self-trans, 18 brands/auc |")
log("| P2        | Seller Closet / Brand Page | High       | 99.2% single-brand auctions   |")
log("| P5        | Category Browse            | Medium     | 45 brands/auc, single dept    |")
log("| P1        | Homepage/Feed              | Medium     | 31% session starts, mixed div |")
log()

log("=" * 80)
log("EVIDENCE BY PLACEMENT")
log("=" * 80)
log()

log("-" * 80)
log("P3 = SEARCH RESULTS - HIGH CONFIDENCE")
log("-" * 80)
log()
log("Behavioral Evidence:")
log("  - 88% self-transition: Users paginate through search repeatedly")
log("  - 77.5% multi-slot clusters: 2 ad slots fire per page load")
log("  - Mean 1.78 auctions/cluster: ~2 promoted listings per search page")
log("  - 60% of all auctions: Search is primary discovery method")
log("  - 54.2% session starts: Highest entry point")
log()
log("Product Diversity Evidence:")
log("  - 18.14 brands/auction: Moderate diversity")
log("  - 8.2% single-brand auctions: Users search for varied products")
log("  - 52,993 unique brands across all P3 auctions")
log()
log("Matches official Poshmark docs: 'high-visibility spots when shoppers search'")
log()

log("-" * 80)
log("P2 = SELLER CLOSET / BRAND PAGE - HIGH CONFIDENCE")
log("-" * 80)
log()
log("Behavioral Evidence:")
log("  - 40% self-transition: LOWEST - users view then leave")
log("  - 21s median gap: Time to browse seller's items")
log("  - 4.00% CTR: HIGHEST - engaged users viewing seller's closet")
log("  - 3% co-firing with P5: Users navigate between category and seller")
log()
log("Product Diversity Evidence (DECISIVE):")
log("  - 1.01 brands/auction: EXTREME homogeneity")
log("  - 99.2% single-brand auctions: Almost always same seller/brand")
log("  - Top 'brand': 'meet the posher' (27.3%) = seller introduction listings")
log()
log("INTERPRETATION:")
log("  P2 fires when users view a SELLER'S CLOSET:")
log("  - All items from same seller (hence single brand/seller pattern)")
log("  - 'Meet the Posher' listings are seller introductions")
log("  - High CTR because users are engaged with specific seller")
log()
log("  This matches official Poshmark 'Brand Pages' placement:")
log("  'Brand pages (where shoppers browse a specific brand)'")
log()
log("NOTE: 'Brand' in Poshmark context often means SELLER not product brand")
log()

log("-" * 80)
log("P5 = CATEGORY BROWSE PAGE - MEDIUM CONFIDENCE")
log("-" * 80)
log()
log("Behavioral Evidence:")
log("  - 69.4% self-transition: Users browse within category")
log("  - 47 winners/auction: Largest grid (many products per page)")
log("  - 0.8% session starts: Users navigate TO category pages")
log("  - Strong P2<->P5 loop: Browse category -> view seller -> return")
log()
log("Product Diversity Evidence (DECISIVE):")
log("  - 45.53 brands/auction: HIGHEST diversity")
log("  - 0.9% single-brand auctions: Products from many brands")
log("  - 99% department '000e8975d97b4e80ef00a955': Single category focus")
log("  - 12.02 unique categories per auction")
log()
log("INTERPRETATION:")
log("  P5 fires when users browse a CATEGORY (e.g., 'Women's Jeans'):")
log("  - Category view shows products from MANY different sellers/brands")
log("  - High brand diversity because category aggregates across sellers")
log("  - Single department = users filtering by one category")
log()
log("  This is NOT the official 'Brand Page' placement (which would be P2).")
log("  P5 may count as 'Search results' in Poshmark's docs when filtered.")
log()

log("-" * 80)
log("P1 = HOMEPAGE/FEED - MEDIUM CONFIDENCE")
log("-" * 80)
log()
log("Behavioral Evidence:")
log("  - 65.8% self-transition: Moderate browsing behavior")
log("  - 43s median gap: Longer dwell time (reading feed)")
log("  - 31.6% session starts: Second-highest entry point")
log("  - 80.8% delivery: High delivery rate (premium placement)")
log("  - <0.1% co-firing with all: Separate page")
log()
log("Product Diversity Evidence:")
log("  - 11.37 brands/auction: Moderate diversity")
log("  - 52.9% single-brand, 36.5% >10 brands: BIMODAL pattern")
log()
log("INTERPRETATION:")
log("  P1's bimodal diversity suggests PERSONALIZED FEED:")
log("  - Sometimes shows brand-specific recommendations (single-brand)")
log("  - Sometimes shows diverse recommendations (multi-brand)")
log("  - Mix of 'items from your favorite sellers' and 'you might like'")
log()
log("  Not an official Poshmark placement (undocumented).")
log()

log("=" * 80)
log("CO-FIRING PATTERN RECONCILIATION")
log("=" * 80)
log()
log("P2 <-> P5 Co-Firing (3% rate, highest pair):")
log()
log("  ORIGINAL interpretation: P2=PDP, P5=Brand -> user views product from brand")
log("  REVISED interpretation:  P2=Seller, P5=Category -> user clicks seller from category")
log()
log("  User flow (revised):")
log("    Category Browse (P5) -> sees products from many sellers")
log("    User clicks on interesting seller -> Seller Closet (P2)")
log("    User browses seller's items (all same brand/seller)")
log("    User returns to category -> Category Browse (P5)")
log()
log("  This explains the P2<->P5 loop and diversity patterns.")
log()

log("=" * 80)
log("MAPPING COMPARISON")
log("=" * 80)
log()
log("ORIGINAL MAPPING (behavioral only):")
log("  P3 = Search Results")
log("  P5 = Brand Page         <- INCORRECT based on diversity")
log("  P2 = PDP Ad Section     <- INCORRECT based on diversity")
log("  P1 = Homepage/Feed")
log()
log("REVISED MAPPING (behavioral + diversity):")
log("  P3 = Search Results     <- CONFIRMED")
log("  P2 = Seller Closet      <- Product diversity decisive (99% single-brand)")
log("  P5 = Category Browse    <- Product diversity decisive (45 brands/auction)")
log("  P1 = Homepage/Feed      <- CONFIRMED")
log()

log("=" * 80)
log("RECONCILIATION WITH OFFICIAL DOCS")
log("=" * 80)
log()
log("Official Poshmark placements: Search Results, Brand Pages")
log()
log("Our 4 placements map as:")
log("  P3 = Search Results (official)")
log("  P2 = 'Brand Pages' (official) - but 'brand' = seller, not product brand")
log("  P5 = Search Results variant (category filter = search)")
log("  P1 = Undocumented (homepage/feed)")
log()
log("NOTE: Poshmark's 'Brand Pages' likely refers to SELLER CLOSETS,")
log("not product brand pages. This aligns with P2's characteristics.")
log()

log("=" * 80)
log("SUMMARY")
log("=" * 80)
log()
log("FINAL PLACEMENT MAPPING:")
log()
log("  P3 = Search Results")
log("       - Users search for items, see diverse results")
log("       - 2 promoted slots per page (multi-slot clusters)")
log()
log("  P2 = Seller Closet / Brand Page")
log("       - Users view seller's closet (all items from same seller)")
log("       - 99.2% single-brand auctions confirms homogeneity")
log("       - Maps to official 'Brand Pages' placement")
log()
log("  P5 = Category Browse")
log("       - Users browse a category (e.g., 'Women's Jeans')")
log("       - 45 brands/auction shows high diversity")
log("       - May map to official 'Search Results' (filtered)")
log()
log("  P1 = Homepage/Feed")
log("       - Personalized recommendations on homepage")
log("       - Mixed diversity (some brand-specific, some varied)")
log("       - Not an official placement (undocumented)")
log()
log("KEY INSIGHT:")
log("  Product diversity analysis was DECISIVE in correcting P2/P5 mapping.")
log("  Behavioral signals alone were insufficient to distinguish seller closet")
log("  from PDP recommendations.")
log()

# Write output
output_path = "/Users/pranjal/Code/topsort-incrementality/analysis/position-effects/eda/placement/results/13_placement_page_mapping.txt"
with open(output_path, "w") as f:
    f.write("\n".join(output_lines))

print()
print(f"Output saved to: {output_path}")
